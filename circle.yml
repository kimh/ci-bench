machine:
  environment:
    PLATFORM: "1.0"
    S3_BUCKET: "s3://ci-bench2"

dependencies:
  override:
    - curl -s https://packagecloud.io/install/repositories/akopytov/sysbench/script.deb.sh | sudo bash
    - sudo apt -y install sysbench
    - mkdir /tmp/benchmark

    # CPU
    - sysbench --events=20000 --time=600 cpu run > /tmp/benchmark/cpu

    # IO
    - sysbench fileio prepare
    - sysbench --file-test-mode=rndrw --max-time=600 --events=10000 fileio run > /tmp/benchmark/io

    # Mysql
    -  mysqladmin -u root -h 127.0.0.1 create dbtest
    -  sysbench --test=/usr/share/sysbench/tests/include/oltp_legacy/oltp.lua --oltp-table-size=100000 --db-driver=mysql --mysql-db=dbtest --mysql-user=root --mysql-host=127.0.0.1 prepare
    -  sysbench --test=/usr/share/sysbench/tests/include/oltp_legacy/oltp.lua --oltp-read-only=off --oltp-table-size=100000 --oltp-test-mode=complex --num-threads=1 --max-requests=0 --max-time=60 --db-driver=mysql --mysql-db=dbtest --mysql-user=root --mysql-host=127.0.0.1 run > /tmp/benchmark/mysql

    - ./generate-result.sh > /tmp/benchmark/result_$CIRCLE_BUILD_NUM.json
    - cat /tmp/benchmark/result_$CIRCLE_BUILD_NUM.json | jq .
    - aws s3 cp /tmp/benchmark/result_$CIRCLE_BUILD_NUM.json $S3_BUCKET/circleci/$PLATFORM/

test:
  override:
    - exit 0
